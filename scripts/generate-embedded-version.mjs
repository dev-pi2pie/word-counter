import { mkdirSync, readFileSync, writeFileSync } from "node:fs";
import { dirname, join, resolve as resolvePath } from "node:path";
import { fileURLToPath } from "node:url";

const scriptDirectory = dirname(fileURLToPath(import.meta.url));
const repositoryRoot = resolvePath(scriptDirectory, "..");
const packageJsonPath = join(repositoryRoot, "package.json");
const outputPath = join(repositoryRoot, "src", "cli", "program", "version-embedded.ts");

const rawPackageJson = readFileSync(packageJsonPath, "utf8");
const packageJson = JSON.parse(rawPackageJson);

const version =
  packageJson && typeof packageJson.version === "string" && packageJson.version.trim().length > 0
    ? packageJson.version.trim()
    : "0.0.0";
const packageName =
  packageJson && typeof packageJson.name === "string" && packageJson.name.trim().length > 0
    ? packageJson.name.trim()
    : "(unknown-package)";

const LOG_PREFIX = "[embedded-version]";

const output = [
  "// This file is generated by scripts/generate-embedded-version.mjs.",
  "// Do not edit manually.",
  `export const EMBEDDED_PACKAGE_VERSION = ${JSON.stringify(version)};`,
  "",
].join("\n");

mkdirSync(dirname(outputPath), { recursive: true });

let existing = null;
try {
  existing = readFileSync(outputPath, "utf8");
} catch {
  // Write the file when it does not exist yet.
}

const getVersionFromGeneratedSource = (source) => {
  if (typeof source !== "string") {
    return null;
  }

  const matched = source.match(/EMBEDDED_PACKAGE_VERSION\s*=\s*"([^"]+)"/);
  return matched?.[1] ?? null;
};

const previousVersion = getVersionFromGeneratedSource(existing);

if (existing === null) {
  writeFileSync(outputPath, output, "utf8");
  console.log(`${LOG_PREFIX} ${packageName} created (none -> ${version})`);
  process.exit(0);
}

if (existing !== output) {
  writeFileSync(outputPath, output, "utf8");
  console.log(
    `${LOG_PREFIX} ${packageName} updated ${previousVersion ?? "(unknown)"} -> ${version}`,
  );
  process.exit(0);
}

console.log(`${LOG_PREFIX} ${packageName} unchanged (${previousVersion ?? version})`);
