name: Publish to GitHub Packages

on:
    push:
        tags:
            - "*"
    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to publish (e.g. v1.2.3)"
                required: true
                type: string
            shallow_since:
                description: "Optional shallow fetch cutoff date (YYYY-MM-DD) for branch validation"
                required: false
                type: string

permissions:
    contents: read
    packages: write

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  # Keep checkout light; branch validation will deepen/unshallow if needed.
                  fetch-depth: 1
                  ref: ${{ inputs.tag && format('refs/tags/{0}', inputs.tag) || github.ref }}
                  show-progress: false

            - name: Resolve tag
              id: tag
              env:
                  TAG_INPUT: ${{ inputs.tag }}
              run: |
                  if [ -n "$TAG_INPUT" ]; then
                    echo "tag=$TAG_INPUT" >> "$GITHUB_OUTPUT"
                  else
                    echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
                  fi

            - name: Ensure tag is on allowed branch
              env:
                  SHALLOW_SINCE: ${{ inputs.shallow_since }}
              run: |
                  if [ -n "$SHALLOW_SINCE" ]; then
                    FETCH_DEPTH_ARGS="--shallow-since=$SHALLOW_SINCE"
                  elif [ -f .git/shallow ]; then
                    FETCH_DEPTH_ARGS="--unshallow"
                  else
                    FETCH_DEPTH_ARGS=""
                  fi

                  git fetch origin main $FETCH_DEPTH_ARGS
                  git fetch origin \
                    "refs/heads/beta*:refs/remotes/origin/beta*" \
                    "refs/heads/alpha*:refs/remotes/origin/alpha*" \
                    "refs/heads/canary*:refs/remotes/origin/canary*" \
                    "refs/heads/dev*:refs/remotes/origin/dev*" \
                    $FETCH_DEPTH_ARGS || true
                  TAG_COMMIT=$(git rev-list -n 1 "${{ steps.tag.outputs.tag }}")
                  if git merge-base --is-ancestor "$TAG_COMMIT" "origin/main"; then
                    echo "Tag commit is on main."
                    exit 0
                  fi

                  MATCHING_BRANCH=$(git for-each-ref --format='%(refname:short)' refs/remotes/origin \
                    | grep -Ei 'origin/.*(beta|alpha|canary|dev)' \
                    | while read -r branch; do
                        if git merge-base --is-ancestor "$TAG_COMMIT" "$branch"; then
                          echo "$branch"
                          break
                        fi
                      done)

                  note() { echo "$1"; }
                  if [ -n "$MATCHING_BRANCH" ]; then
                    note "Tag commit is on allowed branch: $MATCHING_BRANCH"
                  else
                    note "Tag commit is not on main or an allowed branch (beta/alpha/canary/dev)." >&2
                    exit 1
                  fi

            - name: Check pre-release status
              id: prerelease
              env:
                  TAG_NAME: ${{ steps.tag.outputs.tag }}
              run: |
                  PRERELEASE_LABEL=""
                  if [[ "$TAG_NAME" == *-alpha* ]]; then
                    PRERELEASE_LABEL="alpha"
                  elif [[ "$TAG_NAME" == *-beta* ]]; then
                    PRERELEASE_LABEL="beta"
                  elif [[ "$TAG_NAME" == *-rc* ]]; then
                    PRERELEASE_LABEL="rc"
                  elif [[ "$TAG_NAME" == *-canary* ]]; then
                    PRERELEASE_LABEL="canary"
                  fi

                  if [[ -n "$PRERELEASE_LABEL" ]]; then
                    echo "IS_PRERELEASE=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "IS_PRERELEASE=false" >> "$GITHUB_OUTPUT"
                  fi

                  echo "PRERELEASE_LABEL=$PRERELEASE_LABEL" >> "$GITHUB_OUTPUT"

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  registry-url: https://npm.pkg.github.com
                  scope: "@${{ github.repository_owner }}"

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build
              run: bun run build

            - name: Set package name for GitHub Packages
              run: npm pkg set name=@${{ github.repository_owner }}/word-counter

            - name: Publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if [[ "${{ steps.prerelease.outputs.IS_PRERELEASE }}" == "true" ]]; then
                    npm publish --registry https://npm.pkg.github.com --access restricted --tag next
                    PKG_NAME=$(node -p "require('./package.json').name")
                    PKG_VERSION=$(node -p "require('./package.json').version")
                    npm dist-tag add "$PKG_NAME@$PKG_VERSION" "${{ steps.prerelease.outputs.PRERELEASE_LABEL }}" --registry https://npm.pkg.github.com
                  else
                    npm publish --registry https://npm.pkg.github.com --access restricted
                  fi
