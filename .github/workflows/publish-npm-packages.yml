name: Publish to NPM Packages

on:
    push:
        tags:
            - "*"
    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to publish (e.g. v1.2.3)"
                required: true
                type: string

permissions:
    id-token: write # Required for OIDC authentication
    contents: read

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ inputs.tag && format('refs/tags/{0}', inputs.tag) || github.ref }}

            - name: Resolve tag
              id: tag
              env:
                  TAG_INPUT: ${{ inputs.tag }}
              run: |
                  if [ -n "$TAG_INPUT" ]; then
                    echo "tag=$TAG_INPUT" >> "$GITHUB_OUTPUT"
                  else
                    echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
                  fi

            - name: Ensure tag is on allowed branch
              run: |
                  git fetch origin main --depth=100
                  git fetch origin \
                    "refs/heads/beta*:refs/remotes/origin/beta*" \
                    "refs/heads/alpha*:refs/remotes/origin/alpha*" \
                    "refs/heads/canary*:refs/remotes/origin/canary*" \
                    "refs/heads/dev*:refs/remotes/origin/dev*" \
                    --depth=100 || true
                  TAG_COMMIT=$(git rev-list -n 1 "${{ steps.tag.outputs.tag }}")
                  if git merge-base --is-ancestor "$TAG_COMMIT" "origin/main"; then
                    echo "Tag commit is on main."
                    exit 0
                  fi

                  MATCHING_BRANCH=$(git for-each-ref --format='%(refname:short)' refs/remotes/origin \
                    | grep -Ei 'origin/.*(beta|alpha|canary|dev)' \
                    | while read -r branch; do
                        if git merge-base --is-ancestor "$TAG_COMMIT" "$branch"; then
                          echo "$branch"
                          break
                        fi
                      done)

                  note() { echo "$1"; }
                  if [ -n "$MATCHING_BRANCH" ]; then
                    note "Tag commit is on allowed branch: $MATCHING_BRANCH"
                  else
                    note "Tag commit is not on main or an allowed branch (beta/alpha/canary/dev)." >&2
                    exit 1
                  fi

            - name: Check pre-release status
              id: prerelease
              env:
                  TAG_NAME: ${{ steps.tag.outputs.tag }}
              run: |
                  PRERELEASE_LABEL=""
                  if [[ "$TAG_NAME" == *-alpha* ]]; then
                    PRERELEASE_LABEL="alpha"
                  elif [[ "$TAG_NAME" == *-beta* ]]; then
                    PRERELEASE_LABEL="beta"
                  elif [[ "$TAG_NAME" == *-rc* ]]; then
                    PRERELEASE_LABEL="rc"
                  elif [[ "$TAG_NAME" == *-canary* ]]; then
                    PRERELEASE_LABEL="canary"
                  fi

                  if [[ -n "$PRERELEASE_LABEL" ]]; then
                    echo "IS_PRERELEASE=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "IS_PRERELEASE=false" >> "$GITHUB_OUTPUT"
                  fi

                  echo "PRERELEASE_LABEL=$PRERELEASE_LABEL" >> "$GITHUB_OUTPUT"

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  registry-url: https://registry.npmjs.org

            - name: Update npm to latest # Ensuring NPM Trusted Publishing is Work
              run: npm install -g npm@latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build
              run: bun run build

            - name: Publish
              env:
                  NODE_AUTH_TOKEN: ""
              run: |
                  if [[ "${{ steps.prerelease.outputs.IS_PRERELEASE }}" == "true" ]]; then
                    npm publish --registry https://registry.npmjs.org --access public --provenance --tag next
                    PKG_NAME=$(node -p "require('./package.json').name")
                    PKG_VERSION=$(node -p "require('./package.json').version")
                    npm dist-tag add "$PKG_NAME@$PKG_VERSION" "${{ steps.prerelease.outputs.PRERELEASE_LABEL }}" --registry https://registry.npmjs.org
                  else
                    npm publish --registry https://registry.npmjs.org --access public --provenance
                  fi
