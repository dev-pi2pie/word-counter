name: Release

on:
    push:
        tags:
            - "*"
    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to release (e.g. v1.2.3)"
                required: true
                type: string

jobs:
    notes:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: read
        outputs:
            tag: ${{ steps.tag.outputs.tag }}
            prerelease: ${{ steps.prerelease.outputs.IS_PRERELEASE }}
            release_notes: ${{ steps.cliff.outputs.content }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ inputs.tag && format('refs/tags/{0}', inputs.tag) || github.ref }}

            - name: Resolve tag
              id: tag
              env:
                  TAG_INPUT: ${{ inputs.tag }}
              run: |
                  if [ -n "$TAG_INPUT" ]; then
                    echo "tag=$TAG_INPUT" >> "$GITHUB_OUTPUT"
                  else
                    echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
                  fi

            - name: Ensure tag is on allowed branch
              run: |
                  git fetch origin main --depth=100
                  git fetch origin \
                    "refs/heads/beta*:refs/remotes/origin/beta*" \
                    "refs/heads/alpha*:refs/remotes/origin/alpha*" \
                    "refs/heads/canary*:refs/remotes/origin/canary*" \
                    "refs/heads/dev*:refs/remotes/origin/dev*" \
                    --depth=100 || true
                  TAG_COMMIT=$(git rev-list -n 1 "${{ steps.tag.outputs.tag }}")
                  if git merge-base --is-ancestor "$TAG_COMMIT" "origin/main"; then
                    echo "Tag commit is on main."
                    exit 0
                  fi

                  MATCHING_BRANCH=$(git for-each-ref --format='%(refname:short)' refs/remotes/origin \
                    | grep -Ei 'origin/.*(beta|alpha|canary|dev)' \
                    | while read -r branch; do
                        if git merge-base --is-ancestor "$TAG_COMMIT" "$branch"; then
                          echo "$branch"
                          break
                        fi
                      done)

                  note() { echo "$1"; }
                  if [ -n "$MATCHING_BRANCH" ]; then
                    note "Tag commit is on allowed branch: $MATCHING_BRANCH"
                  else
                    note "Tag commit is not on main or an allowed branch (beta/alpha/canary/dev)." >&2
                    exit 1
                  fi

            - name: Check pre-release status
              id: prerelease
              env:
                  TAG_NAME: ${{ steps.tag.outputs.tag }}
              run: |
                  PRERELEASE_LABEL=""
                  if [[ "$TAG_NAME" == *-alpha* ]]; then
                    PRERELEASE_LABEL="alpha"
                  elif [[ "$TAG_NAME" == *-beta* ]]; then
                    PRERELEASE_LABEL="beta"
                  elif [[ "$TAG_NAME" == *-rc* ]]; then
                    PRERELEASE_LABEL="rc"
                  elif [[ "$TAG_NAME" == *-canary* ]]; then
                    PRERELEASE_LABEL="canary"
                  fi

                  if [[ -n "$PRERELEASE_LABEL" ]]; then
                    echo "IS_PRERELEASE=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "IS_PRERELEASE=false" >> "$GITHUB_OUTPUT"
                  fi

                  echo "PRERELEASE_LABEL=$PRERELEASE_LABEL" >> "$GITHUB_OUTPUT"

            - name: Generate release notes
              id: cliff
              uses: orhun/git-cliff-action@v4
              with:
                  config: github
                  args: --latest --strip header
              env:
                  GITHUB_REPO: ${{ github.repository }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    release:
        runs-on: ubuntu-latest
        needs: notes
        permissions:
            contents: write
        steps:
            - name: Create GitHub release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.notes.outputs.tag }}
                  body: ${{ needs.notes.outputs.release_notes }}
                  prerelease: ${{ needs.notes.outputs.prerelease == 'true' }}
